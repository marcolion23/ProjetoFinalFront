<!-- CONTAINER GERAL -->
<div class="container-geral">

  <!-- CARD DO FORMULÁRIO -->
  <mat-card class="product-card">
    <mat-card-title class="titulo-formulario">ATUALIZAR FORNECEDOR</mat-card-title>

    <form class="product-form" #formFornecedor="ngForm">

      <!-- NOME -->
      <mat-form-field appearance="outline" class="full-width spaced-field" required>
        <mat-label>Nome do Formecedor</mat-label>
        <input matInput [(ngModel)]="fornecedor.nome" name="nome" #nome="ngModel" required
          pattern="^[A-Za-zÀ-ÿ\s]+$" (ngModelChange)="capitalizeFirst($event, 'nome')" />
        <mat-error *ngIf="nome.invalid && nome.touched">Apenas letras e espaços</mat-error>
      </mat-form-field>

    
      <!-- EMAIL -->
      <mat-form-field appearance="outline" class="half-width spaced-field" required>
        <mat-label>Email</mat-label>
        <input matInput type="email" [(ngModel)]="fornecedor.email" name="email" #email="ngModel" required email />
        <mat-error *ngIf="email.invalid && email.touched">Email inválido</mat-error>
      </mat-form-field>

      <!-- TELEFONE -->
      <mat-form-field appearance="outline" class="half-width spaced-field" required>
        <mat-label>Telefone</mat-label>
        <input matInput [(ngModel)]="fornecedor.telefone" name="telefone" #telefone="ngModel" required
          [textMask]="{mask: telefoneMask, guide: true}" />
        <mat-error *ngIf="telefone.invalid && telefone.touched">Telefone obrigatório</mat-error>
      </mat-form-field>

      <!-- CONTATO PRINCIPAL -->
      <mat-form-field appearance="outline" class="half-width spaced-field">
        <mat-label>Contato Principal</mat-label>
        <input matInput [(ngModel)]="fornecedor.contatoPrincipal" name="contatoPrincipal"
          #contatoPrincipal="ngModel" pattern="^[A-Za-zÀ-ÿ\s]+$"
          (ngModelChange)="capitalizeFirst($event, 'contatoPrincipal')" />
        <mat-error *ngIf="contatoPrincipal.invalid && contatoPrincipal.touched">Apenas letras e espaços</mat-error>
      </mat-form-field>

      <!-- TELEFONE DO CONTATO -->
      <mat-form-field appearance="outline" class="half-width spaced-field" required>
        <mat-label>Telefone do Contato</mat-label>
        <input matInput [(ngModel)]="fornecedor.telefoneContato" name="telefoneContato" #telefoneContato="ngModel"
          required [textMask]="{mask: telefoneMask, guide: true}" />
        <mat-error *ngIf="telefoneContato.invalid && telefoneContato.touched">Telefone obrigatório</mat-error>
      </mat-form-field>

      <!-- CNPJ -->
      <mat-form-field appearance="outline" class="half-width spaced-field" required>
        <mat-label>CNPJ</mat-label>
        <input matInput [(ngModel)]="fornecedor.cnpj" name="cnpj" #cnpj="ngModel" required
          [textMask]="{mask: cnpjMask, guide: true}" />
        <mat-error *ngIf="cnpj.invalid && cnpj.touched">CNPJ inválido</mat-error>
      </mat-form-field>

      <!-- CEP -->
      <mat-form-field appearance="outline" class="half-width spaced-field" required *ngIf="!mostrarEnderecoManual">
        <mat-label>CEP</mat-label>
        <input matInput
          [(ngModel)]="fornecedor.cep"
          name="cep"
          #cep="ngModel"
          required
          [textMask]="{mask: cepMask, guide: true}"
          (ngModelChange)="onCepChange($event)" />
        <mat-error *ngIf="cep.invalid && cep.touched">CEP inválido</mat-error>
      </mat-form-field>

      <!-- Botão "Não sei o CEP" aparece só se NÃO estiver no modo manual E CEP está vazio -->
      <div class="manual-address-button-container spaced-field" 
           *ngIf="!mostrarEnderecoManual && (!fornecedor.cep || fornecedor.cep.trim() === '')">
        <button mat-stroked-button color="warn" (click)="ativarEnderecoManual()">
          Não sei o CEP
        </button>
      </div>

      <!-- Campos endereço automático -->
      <div *ngIf="!mostrarEnderecoManual && fornecedor.rua && fornecedor.bairro && fornecedor.cidade && fornecedor.estado" class="linha-campos">

        <mat-form-field appearance="outline" class="half-width spaced-field" disabled>
          <mat-label>Estado</mat-label>
          <input matInput [value]="fornecedor.estado" disabled />
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width spaced-field" disabled>
          <mat-label>Cidade</mat-label>
          <input matInput [value]="fornecedor.cidade" disabled />
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width spaced-field" disabled>
          <mat-label>Bairro</mat-label>
          <input matInput [value]="fornecedor.bairro" disabled />
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width spaced-field" disabled>
          <mat-label>Rua</mat-label>
          <input matInput [value]="fornecedor.rua" disabled />
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width spaced-field" required>
          <mat-label>Número</mat-label>
          <input matInput type="number" min="0" [(ngModel)]="fornecedor.numero" name="numero" #numero="ngModel" required />
          <mat-error *ngIf="numero.invalid && numero.touched">Número obrigatório e não pode ser negativo</mat-error>
        </mat-form-field>

      </div>

      <!-- Campos endereço manual -->
      <div *ngIf="mostrarEnderecoManual" class="manual-address-fields">

        <mat-form-field appearance="outline" class="half-width spaced-field" required>
          <mat-label>Estado</mat-label>
          <mat-select [(ngModel)]="fornecedor.estado" name="estado" #estado="ngModel" required (selectionChange)="onEstadoChange($event.value)">
            <mat-option *ngFor="let estado of estadosECidades" [value]="estado.nome">{{ estado.nome }}</mat-option>
          </mat-select>
          <mat-error *ngIf="estado.invalid && estado.touched">Estado é obrigatório</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width spaced-field" required>
          <mat-label>Cidade</mat-label>
          <mat-select [(ngModel)]="fornecedor.cidade" name="cidade" #cidade="ngModel" required (selectionChange)="onCidadeSelecionada($event.value)">
            <mat-option *ngFor="let cidade of cidadesFiltradas" [value]="cidade">{{ cidade }}</mat-option>
          </mat-select>
          <mat-error *ngIf="cidade.invalid && cidade.touched">Cidade é obrigatória</mat-error>
        </mat-form-field>

        <mat-form-field *ngIf="mostrarCampoOutraCidade" appearance="outline" class="half-width spaced-field" required>
          <mat-label>Outra Cidade</mat-label>
          <input matInput [(ngModel)]="nomeOutraCidade" name="nomeOutraCidade" #nomeOutraCidadeRef="ngModel" required (ngModelChange)="capitalizeFirst($event)" />
          <mat-error *ngIf="nomeOutraCidadeRef.invalid && nomeOutraCidadeRef.touched">Informe a cidade</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width spaced-field" required>
          <mat-label>Rua</mat-label>
          <input matInput [(ngModel)]="fornecedor.rua" name="rua" #rua="ngModel" required pattern="^[A-Za-zÀ-ÿ\s]+$" (keydown)="bloquearNumeros($event)" (ngModelChange)="capitalizeFirst($event, 'rua')" />
          <mat-error *ngIf="rua.invalid && rua.touched">Informe apenas letras e espaços</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width spaced-field" required>
          <mat-label>Número</mat-label>
          <input matInput type="number" min="0" [(ngModel)]="fornecedor.numero" name="numero" #numeroManual="ngModel" required />
          <mat-error *ngIf="numeroManual.invalid && numeroManual.touched">Número obrigatório e não pode ser negativo</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width spaced-field">
          <mat-label>Bairro</mat-label>
          <input matInput [(ngModel)]="fornecedor.bairro" name="bairro" #bairro="ngModel" pattern="^[A-Za-zÀ-ÿ\s]+$" (ngModelChange)="capitalizeFirst($event, 'bairro')" />
          <mat-error *ngIf="bairro.invalid && bairro.touched">Informe apenas letras e espaços</mat-error>
        </mat-form-field>

        <!-- Botão "Voltar ao CEP" só aparece aqui, no modo manual -->
        <div class="manual-address-button-container spaced-field">
          <button mat-stroked-button color="primary" (click)="desativarEnderecoManual()">Voltar ao CEP</button>
        </div>
      </div>

      <!-- STATUS -->
      <mat-form-field appearance="outline" class="full-width spaced-field" required>
        <mat-label>Status</mat-label>
        <mat-select [(ngModel)]="fornecedor.status" name="status" #status="ngModel" required>
          <mat-option [value]="true">Ativo</mat-option>
          <mat-option [value]="false">Inativo</mat-option>
        </mat-select>
        <mat-error *ngIf="status.invalid && status.touched">Status é obrigatório</mat-error>
      </mat-form-field>

    </form>

    <!-- Botões principais FORA do formulário -->
    <div class="button-container">
      <button mat-raised-button color="primary" (click)="atualizar()">Atualizar</button>
      <button mat-raised-button color="warn" (click)="cancel()">Cancelar</button>
      <button mat-raised-button color="blue" (click)="limpar()">Limpar</button>
    </div>
  </mat-card>

  <!-- TABELA -->
  <div class="tabela-container">
    <!-- tabela futura -->
  </div>
</div>
